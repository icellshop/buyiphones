<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vende tu iPhone | Oferta Instantánea</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6BLGBmnccaQawoi8SFyQbm8IkDtzwfCM&libraries=places"></script>
  <style>
    :root {
      --main-bg: #f5f5f7;
      --accent: #0071e3;
      --accent-hover: #005bb5;
      --radius: 18px;
      --shadow: 0 6px 32px rgba(0,0,0,0.08);
      --text-main: #1d1d1f;
      --text-light: #86868b;
    }
    html, body { background: var(--main-bg); font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; color: var(--text-main); margin: 0; padding: 0;}
    .container { max-width: 440px; margin: 42px auto; background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 2.1rem 1.2rem 1.2rem 1.2rem;}
    h1 { text-align: center; font-size: 2.1rem; font-weight: 700; margin-bottom: 1.2rem; letter-spacing: -1px;}
    .steps { display: flex; flex-direction: column; gap: 0.4rem;}
    .step { background: #fafbfc; border-radius: var(--radius); margin-bottom: 0.8rem; box-shadow: 0 1px 7px rgba(0,0,0,0.03); overflow: hidden; transition: box-shadow 0.25s; position: relative;}
    .step.active { box-shadow: 0 4px 18px rgba(0,113,227,0.10);}
    .step-header { font-size: 1.11rem; font-weight: 600; color: var(--text-light); padding: 1.1rem 1rem 0.8rem 2.0rem; cursor: pointer; position: relative; background: transparent; border: none; outline: none; display: flex; align-items: center; gap: 0.5rem; transition: color 0.18s; z-index: 2; user-select: none;}
    .step-header.active { color: var(--accent);}
    .step-header:before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--text-light); display: inline-block; margin-right: 0.5em; transition: background 0.2s;}
    .step-header.active:before { background: var(--accent);}
    .step-content { max-height: 0; opacity: 0; padding: 0 1.5rem; overflow: hidden; pointer-events: none; transform: translateY(40px) scale(0.98); transition: max-height 0.65s cubic-bezier(.4,1.4,.55,1), opacity 0.40s cubic-bezier(.4,1.4,.55,1), padding 0.2s, transform 0.38s cubic-bezier(.4,1.4,.55,1);}
    .step.active .step-content { max-height: 500px; opacity: 1; padding: 0 1.5rem 1.3rem 1.5rem; pointer-events: auto; transform: translateY(0) scale(1); transition: max-height 0.7s cubic-bezier(.4,1.4,.55,1), opacity 0.44s cubic-bezier(.4,1.4,.55,1), padding 0.2s, transform 0.42s cubic-bezier(.4,1.4,.55,1);}
    .card-list { display: flex; flex-wrap: wrap; gap: 1.05rem; justify-content: center; margin-top: 0.8rem; margin-bottom: 0.3rem;}
    .card { background: #f9f9fa; border-radius: var(--radius); min-width: 104px; min-height: 110px; padding: 0.7rem 0.9rem 0.5rem 0.9rem; box-shadow: 0 1px 7px rgba(0,0,0,0.03); cursor: pointer; transition: box-shadow 0.18s cubic-bezier(.4,0,.2,1), border 0.18s cubic-bezier(.4,0,.2,1), color 0.18s, background 0.18s; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; font-size: 1.07rem; color: var(--text-main); border: 2px solid transparent; font-weight: 500; outline: none; position: relative; z-index: 1; will-change: box-shadow, border, transform; box-shadow: 0 1px 7px rgba(0,0,0,0.03);}
    .card.selected, .card:focus-visible { border: 2px solid var(--accent); background: #eaf6ff; color: var(--accent); box-shadow: 0 4px 18px rgba(0,113,227,0.12); z-index: 2; transform: scale(1.04);}
    .card:hover:not(.selected) { border: 2px solid #e0e0e5; background: #f1faff; box-shadow: 0 3px 12px rgba(0,113,227,0.08); color: var(--accent-hover); transform: scale(1.04);}
    .card-img { width: 54px; height: 54px; margin-bottom: 0.5rem; object-fit: contain; filter: drop-shadow(0px 1px 2px #0002); pointer-events: none; user-select: none; background: #fff; border-radius: 13px; border: 1px solid #eee;}
    .result-offer { text-align: center; margin: 1.2rem 0 0 0; font-size: 1.34rem; font-weight: 700; color: var(--accent); letter-spacing: -0.5px; animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.55,1);}
    .no-offer { color: #d00; font-weight: 500; text-align: center; margin-top: 1.8rem; font-size: 1.05rem; animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.55,1);}
    .accept-btn, .restart-btn, .submit-btn { width: 100%; padding: 0.93rem 0; font-size: 1.11rem; font-weight: 600; border: none; border-radius: var(--radius); background: var(--accent); color: #fff; cursor: pointer; margin-top: 1.5rem; box-shadow: 0 2px 10px rgba(0,113,227,0.06); transition: background 0.16s; display: block; animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.55,1);}
    .accept-btn { margin-bottom: 0.5rem;}
    .form-section { animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.55,1); margin-top: 1.2rem; margin-bottom: 1.0rem;}
    .form-group { margin-bottom: 1.1rem;}
    label { display: block; font-size: 1.01rem; color: var(--text-light); margin-bottom: 0.28rem; font-weight: 500;}
    input[type="text"], input[type="email"], textarea, select { width: 100%; padding: 0.7rem 0.8rem; border-radius: 10px; border: 1.2px solid #d7d7dd; background: #f6f6fa; font-size: 1.07rem; margin-bottom: 0.1rem; color: var(--text-main); font-family: inherit; transition: border 0.18s; box-sizing: border-box;}
    input:focus, textarea:focus, select:focus { border: 1.5px solid var(--accent); outline: none; background: #eaf6ff;}
    .form-row { display: flex; gap: 0.6rem;}
    .form-row > * { flex: 1; }
    .form-note { color: var(--text-light); font-size: 0.96rem; margin-bottom: 1.1rem; margin-top: -0.7rem;}
    .form-success { color: var(--accent); text-align: center; font-size: 1.09rem; font-weight: 600; margin-top: 1.4rem; animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.55,1);}
    .form-error { color: #d00; text-align: center; font-size: 1.01rem; margin-top: 0.6rem; animation: fadeInUp 0.7s cubic-bezier(.4,1.4,.55,1);}
    .loading, .error-msg { text-align: center; margin: 2.1rem 0 1.2rem 0; font-size: 1.08rem; color: var(--accent); animation: fadeIn 1.2s;}
    .error-msg { color: #d00; }
    .payment-methods-list { display: flex; gap: 1rem; margin-bottom: 1.1rem; justify-content: center; flex-wrap: wrap;}
    .payment-method-btn { display: flex; align-items: center; gap: 0.7em; border: 2px solid transparent; background: #f6f6fa; border-radius: 12px; cursor: pointer; padding: 0.6em 1.1em 0.6em 0.7em; font-size: 1.07rem; font-weight: 500; transition: border 0.2s cubic-bezier(.4,1.4,.55,1), box-shadow 0.2s cubic-bezier(.4,1.4,.55,1), background 0.18s; color: var(--text-main); min-width: 120px; min-height: 48px; box-shadow: 0 1px 7px rgba(0,0,0,0.03);}
    .payment-method-btn.selected { border: 2px solid var(--accent); background: #eaf6ff; color: var(--accent); box-shadow: 0 3px 12px rgba(0,113,227,0.08); transform: scale(1.04);}
    .payment-method-btn:hover:not(.selected) { border: 2px solid #e0e0e5; background: #f1faff; color: var(--accent-hover); transform: scale(1.04);}
    .payment-method-img { width: 34px; height: 34px; border-radius: 7px; background: #fff; object-fit: contain; border: 1px solid #eee; box-shadow: 0 1px 3px #0002;}
    .payment-confirm-group { margin-bottom: 1.1rem; animation: fadeInUp 0.6s;}
    .payment-confirm-label { font-size: 1.01rem; color: var(--text-light); margin-bottom: 0.28rem; font-weight: 500; display: block;}
    .payment-confirm-input { width: 100%; padding: 0.7rem 0.8rem; border-radius: 10px; border: 1.2px solid #d7d7dd; background: #f6f6fa; font-size: 1.07rem; margin-bottom: 0.1rem; color: var(--text-main); font-family: inherit; transition: border 0.18s; box-sizing: border-box;}
    .payment-confirm-input:focus { border: 1.5px solid var(--accent); outline: none; background: #eaf6ff;}
    .summary-page { padding: 2.1rem 1.2rem 1.2rem 1.2rem; background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); max-width: 440px; margin: 42px auto;}
    .summary-title { font-size: 1.45rem; font-weight: 700; text-align: center; color: var(--accent); margin-bottom: 1.1rem;}
    .summary-section { margin: 1.2rem 0;}
    .summary-label { color: var(--text-light); font-size: 1.02rem; margin-bottom: 0.1rem;}
    .summary-value { font-size: 1.18rem; font-weight: 600; color: var(--text-main);}
    .summary-disclaimer { background: #f6f6fa; border-radius: 11px; padding: 1.1rem 1rem; color: #7a4d00; font-size: 1.01rem; margin: 1.2rem 0 1.7rem 0; border: 1.5px solid #ffe6b3;}
    .summary-guide { text-align: center; margin: 1.6rem 0 1.2rem 0;}
    .summary-guide b { color: var(--accent);}
    .summary-btn {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 1.13rem;
      padding: 0.92em 0;
      cursor: pointer;
      margin-top: 1.3rem;
      transition: background 0.17s;
      text-decoration: none;
    }
    .summary-btn:hover { background: var(--accent-hover);}
    #contacto-error { margin-top: 0; }
    @media (max-width: 650px) {
      .summary-page { max-width: 98vw; padding: 1.2rem 0.2rem 0.4rem 0.2rem;}
    }
  </style>
</head>
<body>
  <div id="mainContent">
    <div class="container">
      <h1>Vende tu iPhone</h1>
      <div class="steps" id="steps"></div>
    </div>
  </div>
  <script>
    // ...Todo tu código JS igual hasta la declaración de funciones...

    // --- Agrega al inicio del script estos objetos para el remitente y paquete ---
    const DEFAULT_FROM_ADDRESS = {
      name: "ICellShop",
      street1: "2506 E COWAN CIR",
      street2: "",
      city: "Phoenix",
      state: "AZ",
      zip: "85050",
      country: "US",
      phone: "555-123-4567",
      email: "icellshop@correo.com"
    };
    const DEFAULT_PARCEL = {
      length: 20,
      width: 15,
      height: 10,
      weight: 500
    };

    // ...Todo tu código hasta el submit del formulario...

    // En el addEventListener('submit',...) de tu formulario, REEMPLAZA el fetch a /generar-etiqueta por este:
    document.getElementById('sellForm')?.addEventListener('submit', async function(e){
      e.preventDefault();
      // ...validaciones igual que antes...
      if (!validateContactoField()) return;
      if (paymentConfirmInput) paymentConfirmInput.dispatchEvent(new Event('input'));
      if (paymentErrorDiv && paymentErrorDiv.textContent) return;
      const nombre = document.getElementById('nombre').value;
      const contacto = document.getElementById('contacto').value;
      const street1 = document.getElementById('street1').value;
      const street2 = document.getElementById('street2').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const zip = document.getElementById('zip').value;
      const payment = window.paymentButtonState.selected;
      const paymentValue = window.paymentButtonState.confirmValue;
      if (!payment) {
        window.paymentButtonState.error = "Selecciona el método de pago.";
        renderSteps();
        return;
      }
      if (!paymentValue || paymentValue.length < 3) {
        window.paymentButtonState.error = "Confirma correctamente la cuenta/correo/teléfono asociado.";
        renderSteps();
        return;
      }
      if (!street1 || !city || !state || !zip) {
        formError = 'Selecciona una dirección válida de la lista de Google.';
        formValidating = false;
        renderSteps(); return;
      }
      formValidating = true; formError = '';
      renderSteps();
      try {
        const response = await fetch('/validar-direccion', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ street1, street2, city, state, zip })
        });
        const data = await response.json();
        if (data.status === 'valid') {
          document.getElementById('etiquetaResult').innerHTML = "Generando etiqueta...";
          try {
            // --- Aquí el cambio importante: ahora SÍ mandas from_address y parcel ---
            const etiquetaResp = await fetch('/generar-etiqueta', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                to_address: {
                  name: nombre,
                  street1,
                  street2,
                  city,
                  state,
                  zip,
                  country: "US",
                  phone: contacto,
                  email: contacto
                },
                from_address: DEFAULT_FROM_ADDRESS,
                parcel: DEFAULT_PARCEL,
                contacto,
                payment_method: payment.value,
                payment_value: paymentValue
              })
            });
            const etiquetaData = await etiquetaResp.json();
            if (etiquetaData.status === 'success') {
              window.formState = {
                nombre: "",
                contacto: "",
                autocomplete: "",
                street1: "",
                street2: "",
                city: "",
                state: "",
                zip: ""
              };
              lastResumenData = {
                label_url: etiquetaData.label_url,
                tracking_code: etiquetaData.tracking_code,
                envio: {
                  model: selection.model,
                  carrier: selection.carrier,
                  storage: selection.storage,
                  condition: selection.condition,
                  nombre,
                  direccion: { street1, street2, city, state, zip },
                  contacto,
                  metodo: payment.value,
                  metodo_id: paymentValue
                }
              };
              formSubmitted = true;
              formValidating = false;
              renderSteps();
            } else {
              document.getElementById('etiquetaResult').innerHTML = "Error generando etiqueta: " + (etiquetaData.message || "Error desconocido");
              formValidating = false;
            }
          } catch (err) {
            document.getElementById('etiquetaResult').innerHTML = "Error generando etiqueta: " + err.message;
            formValidating = false;
          }
        } else if (data.status === 'suggestion') {
          formError = '¿Quizá quisiste decir: ' +
            data.suggestion.street1 + ', ' +
            (data.suggestion.street2 ? (data.suggestion.street2 + ', ') : '') +
            data.suggestion.city + ', ' + data.suggestion.state + ', ' + data.suggestion.zip +
            '? Corrige la dirección, por favor.';
          formValidating = false;
          renderSteps();
        } else {
          formError = data.message || 'Dirección no válida. Revisa tus datos.';
          formValidating = false;
          renderSteps();
        }
      } catch (err) {
        formError = 'Error validando la dirección. Intenta de nuevo.';
        formValidating = false;
        renderSteps();
      }
    });

    // ...El resto de tu JS igual (renderSteps, renderSummaryPage, etc)...
    // ...No olvides dejar tu inicialización de la app y demás funciones igual...
  </script>
</body>
</html>
